package com.services.ConfigService.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.config.server.EnableConfigServer;
import org.springframework.cloud.config.server.repository.JdbcConfigRepository;
import org.springframework.cloud.config.server.repository.CompositeConfigRepository;
import org.springframework.cloud.config.server.repository.EnvironmentRepository;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.sql.DataSource;
import java.util.Arrays;

@Configuration
@EnableConfigServer
public class ConfigServerConfig {

    @Value("${spring.datasource.url}")
    private String datasourceUrl;

    @Value("${spring.datasource.username}")
    private String datasourceUsername;

    @Value("${spring.datasource.password}")
    private String datasourcePassword;

    @Bean
    public DataSource dataSource() {
        // Create and configure your DataSource bean here
        // Example with HikariCP:
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl(datasourceUrl);
        dataSource.setUsername(datasourceUsername);
        dataSource.setPassword(datasourcePassword);
        return dataSource;
    }

    @Bean
    public EnvironmentRepository environmentRepository() {
        return new JdbcConfigRepository(dataSource(), "SELECT `value` FROM `config_properties` WHERE `key` = ? AND `profile` = ? AND `label` = ?");
    }

    @Bean
    public CompositeConfigRepository compositeRepository() {
        return new CompositeConfigRepository(Arrays.asList(environmentRepository()));
    }
}

